{
  "name": "lead_qualify_and_reply",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot-webhook",
        "responseMode": "responseNode"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 300],
      "webhookId": "chatwoot-incoming"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.event}}",
              "operation": "equals",
              "value2": "message_created"
            },
            {
              "value1": "={{$json.message_type}}",
              "operation": "equals",
              "value2": "incoming"
            }
          ]
        }
      },
      "name": "Is Incoming Message?",
      "type": "n8n-nodes-base.if",
      "position": [300, 300]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "leads",
        "returnAll": false,
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "phone",
              "value": "={{$json.sender.phone_number}}"
            }
          ]
        }
      },
      "name": "Load Lead",
      "type": "n8n-nodes-base.supabase",
      "position": [500, 300],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "lead_offers",
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{$json.id}}"
            },
            {
              "column": "status",
              "operation": "notIn",
              "value": "STOPPED,DISQUALIFIED,SENT_TO_DEVELOPER"
            }
          ]
        }
      },
      "name": "Load Active Lead Offers",
      "type": "n8n-nodes-base.supabase",
      "position": [700, 300],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are a lead qualification assistant. Extract the following fields from the user message if present:\n- budget (min/max, currency)\n- zone (neighborhoods/areas)\n- timing (when they want to move/buy)\n- intent (buy, rent, invest)\n- preferences (bedrooms, floor preference, amenities)\n- name\n\nRespond with a JSON object containing only the fields that were mentioned."
            },
            {
              "role": "user",
              "content": "={{$json.content}}"
            }
          ]
        },
        "options": {
          "responseFormat": "json_object"
        }
      },
      "name": "Extract Qualification Fields",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [900, 200],
      "credentials": {
        "openAiApi": "openai"
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM search_rag_chunks_vector($1, $2, $3, 5)",
        "values": [
          "={{$node['Load Active Lead Offers'].json.tenant_id}}",
          "={{$node['Load Active Lead Offers'].json.offer_id}}",
          "={{$node['Generate Embedding'].json.embedding}}"
        ]
      },
      "name": "RAG Hybrid Search",
      "type": "n8n-nodes-base.supabase",
      "position": [1100, 300],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "offer_variants",
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "offer_id",
              "value": "={{$node['Load Active Lead Offers'].json.offer_id}}"
            }
          ]
        }
      },
      "name": "Load Offer Variants",
      "type": "n8n-nodes-base.supabase",
      "position": [900, 400],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Sos el asistente de calificación de {{tenant_name}}. Tu objetivo es calificar leads para proyectos inmobiliarios.\n\nREGLAS ESTRICTAS:\n- No confirmes disponibilidad; decí que se confirma al avanzar.\n- No prometas tasa fija, cuotas o descuentos; solo mencioná que hay opciones y se revisan caso a caso.\n- Si el usuario pide confirmación exacta, pedí datos mínimos y ofrecé que el equipo lo valide al recibir el lead.\n- Mensajes cortos, una pregunta a la vez cuando sea posible.\n- Tono formal pero cercano, voseo argentino moderado.\n\nCAMPOS A OBTENER:\n1. Nombre completo\n2. Presupuesto aproximado\n3. Zonas de interés\n4. Timing (cuándo quiere mudarse/concretar)\n5. Intención (compra, alquiler, inversión)\n6. Preferencias (ambientes, piso alto/bajo, orientación)\n\nINVENTARIO DISPONIBLE:\n{{variants}}\n\nCONTEXTO RAG:\n{{rag_context}}\n\nCAMPOS YA OBTENIDOS:\n{{qualification_fields}}"
            },
            {
              "role": "user", 
              "content": "={{$json.content}}"
            }
          ]
        },
        "options": {
          "maxTokens": 300,
          "temperature": 0.7
        }
      },
      "name": "Generate Response",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1300, 300],
      "credentials": {
        "openAiApi": "openai"
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": "public",
        "table": "lead_offers",
        "filters": {
          "values": [
            {
              "column": "id",
              "value": "={{$node['Load Active Lead Offers'].json.id}}"
            }
          ]
        },
        "fieldsUi": {
          "values": [
            {
              "column": "qualification_fields",
              "value": "={{$json.merged_qualification}}"
            },
            {
              "column": "status",
              "value": "={{$json.new_status}}"
            }
          ]
        }
      },
      "name": "Update Lead Offer",
      "type": "n8n-nodes-base.supabase",
      "position": [1500, 300],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.CHATWOOT_BASE_URL}}/api/v1/accounts/{{$env.CHATWOOT_ACCOUNT_ID}}/conversations/{{$json.conversation_id}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{$env.CHATWOOT_API_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{$node['Generate Response'].json.content}}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            }
          ]
        }
      },
      "name": "Send Chatwoot Message",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1700, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.score_total}}",
              "operation": "greaterOrEqual",
              "value2": "={{$json.threshold}}"
            }
          ]
        }
      },
      "name": "Score >= Threshold?",
      "type": "n8n-nodes-base.if",
      "position": [1700, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM consume_credit($1, $2, $3, 'Lead delivery')",
        "values": [
          "={{$json.tenant_id}}",
          "={{$json.delivery_id}}",
          "={{$json.lead_offer_id}}"
        ]
      },
      "name": "Consume Credit",
      "type": "n8n-nodes-base.supabase",
      "position": [1900, 400],
      "credentials": {
        "supabaseApi": "supabase_service"
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.success}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Credit Available?",
      "type": "n8n-nodes-base.if",
      "position": [2100, 400]
    },
    {
      "parameters": {
        "resource": "sheet",
        "operation": "appendOrUpdate",
        "documentId": "={{$env.GOOGLE_SHEETS_SPREADSHEET_ID}}",
        "sheetName": "Leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Lead ID": "={{$json.lead_id}}",
            "Name": "={{$json.name}}",
            "Phone": "={{$json.phone}}",
            "Email": "={{$json.email}}",
            "Budget": "={{$json.budget}}",
            "Zone": "={{$json.zone}}",
            "Timing": "={{$json.timing}}",
            "Intent": "={{$json.intent}}",
            "Score": "={{$json.score_total}}",
            "Offer": "={{$json.offer_name}}",
            "Delivered At": "={{$now}}"
          }
        }
      },
      "name": "Append to Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "position": [2300, 300],
      "credentials": {
        "googleSheetsOAuth2Api": "google_sheets"
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"processed\"}"
      },
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1900, 200]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [{"node": "Is Incoming Message?", "type": "main", "index": 0}]
      ]
    },
    "Is Incoming Message?": {
      "main": [
        [{"node": "Load Lead", "type": "main", "index": 0}],
        [{"node": "Respond OK", "type": "main", "index": 0}]
      ]
    },
    "Load Lead": {
      "main": [
        [{"node": "Load Active Lead Offers", "type": "main", "index": 0}]
      ]
    },
    "Load Active Lead Offers": {
      "main": [
        [
          {"node": "Extract Qualification Fields", "type": "main", "index": 0},
          {"node": "Load Offer Variants", "type": "main", "index": 0}
        ]
      ]
    },
    "Extract Qualification Fields": {
      "main": [
        [{"node": "RAG Hybrid Search", "type": "main", "index": 0}]
      ]
    },
    "RAG Hybrid Search": {
      "main": [
        [{"node": "Generate Response", "type": "main", "index": 0}]
      ]
    },
    "Generate Response": {
      "main": [
        [
          {"node": "Update Lead Offer", "type": "main", "index": 0},
          {"node": "Send Chatwoot Message", "type": "main", "index": 0}
        ]
      ]
    },
    "Update Lead Offer": {
      "main": [
        [{"node": "Score >= Threshold?", "type": "main", "index": 0}]
      ]
    },
    "Score >= Threshold?": {
      "main": [
        [{"node": "Consume Credit", "type": "main", "index": 0}],
        [{"node": "Respond OK", "type": "main", "index": 0}]
      ]
    },
    "Consume Credit": {
      "main": [
        [{"node": "Credit Available?", "type": "main", "index": 0}]
      ]
    },
    "Credit Available?": {
      "main": [
        [{"node": "Append to Sheets", "type": "main", "index": 0}],
        [{"node": "Respond OK", "type": "main", "index": 0}]
      ]
    },
    "Append to Sheets": {
      "main": [
        [{"node": "Respond OK", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}


